# 解压缩功能集成说明

## 概述

本项目已成功集成了通用的解压缩功能，支持多种压缩格式的自动和手动解压缩。该功能已完全集成到包管理器（PackageManager）中，可以在下载文件后自动解压，也可以手动调用解压功能。

## 新增功能

### 1. 支持的压缩格式

- **ZIP格式**: `.zip`
- **TAR格式**: `.tar`, `.tar.gz`, `.tgz`, `.tar.bz2`
- **GZIP格式**: `.gz`
- **其他格式**: 配置中还支持 `.rar`, `.7z`（需要相应的解压工具）

### 2. 核心组件

#### ExtractionService 类
- 位置: `test_framework/utils/packge.py`
- 功能: 提供通用的解压缩服务
- 主要方法:
  - `extract_archive()`: 解压单个压缩文件
  - `extract_multiple_archives()`: 批量解压多个文件
  - `auto_extract_directory()`: 自动解压目录中的所有压缩文件

#### ExtractionConfig 数据类
- 配置解压缩行为的所有参数
- 支持动态配置更新

#### ExtractionSummary 数据类
- 提供解压缩操作的详细摘要信息

### 3. 集成到 PackageManager

#### 新增方法
- `extract_package_archives()`: 手动解压指定目录的压缩文件
- `get_supported_archive_formats()`: 获取支持的压缩格式列表
- `update_extraction_config()`: 动态更新解压缩配置
- `_auto_extract_downloaded_files()`: 自动解压下载的文件（内部方法）

#### 自动解压集成
- 在 `_download_from_windows_share()` 方法中集成
- 当 `auto_extract=True` 时，下载完成后自动解压
- 支持配置清理原始压缩文件

## 配置说明

### 主配置文件 (main_config.json)

```json
{
  "package_manager": {
    "extraction": {
      "enabled": true,                    // 启用解压缩功能
      "auto_extract": true,              // 自动解压下载的文件
      "extract_path": "./extracted",     // 解压目标路径
      "supported_formats": [             // 支持的压缩格式
        ".zip", ".rar", ".7z", ".tar", ".tar.gz", ".tar.bz2"
      ],
      "overwrite_existing": true,        // 覆盖已存在的文件
      "preserve_structure": true,        // 保持目录结构
      "cleanup_archives": true,          // 解压后删除原始压缩文件
      "max_extract_size": 524288000,     // 最大解压大小（字节）
      "password_protected": {            // 密码保护的压缩文件
        "enabled": false,
        "default_passwords": ["123456", "password", "admin"]
      }
    }
  }
}
```

### 配置参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `enabled` | bool | true | 是否启用解压缩功能 |
| `auto_extract` | bool | true | 是否自动解压下载的文件 |
| `extract_path` | str | "extracted" | 解压目标路径 |
| `supported_formats` | list | [常见格式] | 支持的压缩格式列表 |
| `overwrite_existing` | bool | true | 是否覆盖已存在的文件 |
| `preserve_structure` | bool | true | 是否保持原始目录结构 |
| `cleanup_archives` | bool | false | 解压后是否删除原始压缩文件 |
| `max_extract_size` | int | 500MB | 最大允许解压的文件大小 |
| `password_protected` | dict | - | 密码保护文件的处理配置 |

## 使用示例

### 1. 基本手动解压

```python
from test_framework.services.package_manager import PackageManager

# 配置
config = {
    "extraction": {
        "enabled": True,
        "auto_extract": False,
        "extract_path": "./extracted",
        "overwrite_existing": True
    }
}

# 创建包管理器
package_manager = PackageManager(config)

# 手动解压
summary = package_manager.extract_package_archives(
    "./downloads",      # 源目录
    "./extracted"       # 目标目录
)

print(f"解压了 {summary.extracted_files} 个文件")
```

### 2. 自动解压配置

```python
config = {
    "extraction": {
        "enabled": True,
        "auto_extract": True,     # 启用自动解压
        "cleanup_archives": True  # 解压后删除原文件
    },
    "windows_share": {
        "sync_packages": [
            {
                "name": "firmware",
                "share_path": "//server/shared/firmware",
                "local_path": "./downloads/firmware",
                "extensions": [".zip", ".tar.gz"]
            }
        ]
    }
}

# 当从Windows共享下载文件时，压缩文件会自动解压
```

### 3. 动态配置更新

```python
# 运行时更新配置
package_manager.update_extraction_config({
    "auto_extract": True,
    "cleanup_archives": True,
    "max_extract_size": 200 * 1024 * 1024  # 200MB
})
```

## 安全特性

1. **路径安全检查**: 防止目录遍历攻击（../ 路径）
2. **大小限制**: 可配置最大解压文件大小，防止解压炸弹
3. **格式验证**: 只处理配置中指定的压缩格式
4. **错误处理**: 完善的异常处理和日志记录

## 测试验证

### 测试脚本
- `test_extraction_integration.py`: 完整的集成测试
- `extraction_usage_example.py`: 使用示例演示

### 测试覆盖
- ✅ 配置加载测试
- ✅ 手动解压测试
- ✅ 配置更新测试
- ✅ 主配置集成测试

### 运行测试

```bash
# 运行集成测试
python3 test_extraction_integration.py

# 运行使用示例
python3 extraction_usage_example.py
```

## 文件结构

```
test_framework/
├── utils/
│   └── packge.py                    # 包含 ExtractionService 等核心类
├── services/
│   └── package_manager.py           # 集成了解压缩功能的包管理器
├── config/
│   └── main_config.json            # 主配置文件（包含解压缩配置）
└── ...

# 测试和示例文件
test_extraction_integration.py       # 集成测试脚本
extraction_usage_example.py          # 使用示例脚本
解压缩功能说明.md                    # 本说明文档
```

## 注意事项

1. **依赖要求**: 确保系统已安装 Python 3.6+ 和相关的压缩库
2. **权限问题**: 确保有足够的文件系统权限进行解压操作
3. **磁盘空间**: 解压前检查目标目录的可用空间
4. **网络下载**: 自动解压功能仅在从Windows共享下载时触发
5. **配置更新**: 配置更新仅影响当前实例，不会修改配置文件

## 后续扩展

1. **更多格式支持**: 可以添加对 `.rar`, `.7z` 等格式的原生支持
2. **密码保护**: 完善密码保护压缩文件的处理
3. **进度回调**: 添加解压进度的回调机制
4. **并行解压**: 支持多线程并行解压多个文件
5. **增量解压**: 支持只解压新文件或修改过的文件

---

**版本**: 1.0  
**更新日期**: 2025-08-13  
**状态**: 已完成并测试通过